<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>HoloOS // Multiverse Inc.</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.5.4/socket.io.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@600&display=swap" rel="stylesheet">
<style>
body{margin:0;overflow:hidden;background:#000;color:#0ff;font-family:'Orbitron',monospace;}
#cursor{position:absolute;width:50px;height:50px;border:2px solid #0ff;border-radius:50%;
transform:translate(-50%,-50%);pointer-events:none;}
#fill{position:absolute;width:46px;height:46px;top:2px;left:2px;clip-path:circle(0% at center);
background:#0ff6;border-radius:50%;transition:clip-path 0.1s linear;}
.window{position:absolute;border:2px solid #0ff;border-radius:5px;background:rgba(0,40,60,0.6);
box-shadow:0 0 15px #0ff8;display:none;}
.header{font-size:12px;text-align:center;border-bottom:1px solid #0ff;}
textarea{background:#022;color:#0f0;width:100%;height:100%;border:none;}
#dock{position:fixed;bottom:20px;left:50%;transform:translateX(-50%);display:flex;gap:20px;}
.dock-icon{width:90px;height:90px;border:1px solid #044;border-radius:10px;text-align:center;
background:rgba(0,255,255,0.08);display:flex;flex-direction:column;justify-content:center;align-items:center;
font-size:13px;}
.hidden{opacity:0;pointer-events:none;}
#splash1,#splash2{position:fixed;inset:0;background:#000;display:flex;align-items:center;justify-content:center;
color:#0ff;font-size:3em;letter-spacing:3px;z-index:999;transition:opacity 1s ease;}
canvas{display:block;}
</style>
</head>
<body>

<!-- Fenêtre d'activation -->
<div id="activation" style="position:fixed;inset:0;background:#000;z-index:1500;display:flex;
flex-direction:column;align-items:center;justify-content:center;font-family:'Orbitron';color:#0ff;">
  <h1>🔑 Activation requise</h1>
  <input id="licenseKey" placeholder="Entrer votre clé" 
         style="padding:10px;font-size:16px;width:260px;border:2px solid #0ff;
                background:#011;color:#0ff;text-align:center;border-radius:6px;">
  <div style="margin-top:10px;">
    <button id="checkBtn" style="padding:8px 16px;background:none;color:#0ff;border:2px solid #0ff;
                 border-radius:6px;cursor:pointer;">Vérifier</button>
    <button id="getKeyBtn" style="padding:8px 16px;background:none;color:#0ff;border:2px solid #0ff;
                 border-radius:6px;cursor:pointer;margin-left:10px;">Obtenir une clé</button>
  </div>
  <div id="keyMsg" style="margin-top:20px;font-size:14px;color:#f03;"></div>
</div>

<!-- Splash -->
<div id="splash1" style="display:none;">HOLO OS</div>
<div id="splash2" style="display:none;">By Multiverse Inc.</div>

<div id="ui" style="display:none;">
  <div id="cursor"><div id="fill"></div></div>

  <!-- Dock -->
  <div id="dock">
    <div class="dock-icon" id="icon-clock">🕒<br>Horloge</div>
    <div class="dock-icon" id="icon-system">💻<br>Système</div>
    <div class="dock-icon" id="icon-notes">📝<br>Notes</div>
    <div class="dock-icon" id="icon-weather">🌤️<br>Météo</div>
    <div class="dock-icon" id="icon-draw">🎨<br>Dessin</div>
    <div class="dock-icon" id="icon-saver">🌌<br>ScreenSaver</div>
  </div>

  <!-- Fenêtres -->
  <div class="window" id="win-clock" style="width:150px;height:80px;">
    <div class="header">HORLOGE</div><div id="clock" style="text-align:center;padding:5px;"></div>
  </div>
  <div class="window" id="win-system" style="width:200px;height:90px;">
    <div class="header">SYSTÈME</div><div id="sysinfo" style="padding:5px;"></div>
  </div>
  <div class="window" id="win-notes" style="width:250px;height:150px;">
    <div class="header">NOTES</div><textarea id="notes"></textarea>
  </div>
  <div class="window" id="win-weather" style="width:220px;height:100px;">
    <div class="header">MÉTÉO</div><div id="meteo" style="padding:5px;"></div>
  </div>
  <div class="window" id="win-draw" style="width:550px;height:400px;">
    <div class="header">DESSIN</div>
    <canvas id="drawCanvas" width="520" height="360"
            style="background:#111;border:1px solid #0ff;margin:10px;"></canvas>
  </div>
  <div id="screensaver" style="display:none;position:fixed;inset:0;background:#000;z-index:500;">
    <iframe src="https://crazy-indigo-i3bpgcshh5.edgeone.app/" style="width:100%;height:100%;border:none;"></iframe>
    <div style="position:absolute;bottom:10px;width:100%;text-align:center;
                font-family:'Orbitron';font-size:18px;color:#0ff;">
      ✊ Fermez la main 5 s pour quitter l’écran de veille
    </div>
  </div>
</div>

<script>
const socket=io();
const vw=1920,vh=1080;
const cursor=document.getElementById('cursor'),fill=document.getElementById('fill');
const dockIcons=document.querySelectorAll('.dock-icon'),windows=document.querySelectorAll('.window');
let grabbed=null,offsetX=0,offsetY=0,HOLD_TIME=3000,target=null,holdStart=null,holding=false;
let saverActive=false,saverStart=null;

// -------- Activation ----------
const act=document.getElementById('activation');
document.getElementById('getKeyBtn').onclick=()=>window.open("mailto:maelm1405@gmail.com?subject=Clé D'activation HoloOS&body=Demande de clé. Mon adresse mail connecté a mon paypal : tonemail@mail.com","_blank");
document.getElementById('checkBtn').onclick=async()=>{
  const key=document.getElementById('licenseKey').value.trim();
  document.getElementById('keyMsg').textContent="Vérification...";
  const res=await fetch('/verify_key',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({key})});
  const data=await res.json();
  if(data.valid){
    document.getElementById('keyMsg').style.color="#0f0";
    document.getElementById('keyMsg').textContent="Clé validée ✔";
    setTimeout(()=>{act.style.display='none';document.getElementById('splash1').style.display='flex';
                     document.getElementById('splash2').style.display='flex';launchSplash();},800);
  } else {
    document.getElementById('keyMsg').style.color="#f03";
    document.getElementById('keyMsg').textContent="❌ Clé invalide";
  }
};

// -------- Splash sequence --------
function launchSplash(){
 setTimeout(()=>{
  const s1=document.getElementById('splash1'),s2=document.getElementById('splash2');
  s1.classList.add('hidden');
  setTimeout(()=>{
    s1.style.display='none';s2.style.opacity=1;
    setTimeout(()=>{
      s2.classList.add('hidden');
      setTimeout(()=>{s2.style.display='none';document.getElementById('ui').style.display='block';},1000);
    },1500);
  },1000);
 },100);
}

// -------- Apps --------
setInterval(()=>{document.getElementById('clock').textContent=new Date().toLocaleTimeString();},1000);
async function updateSystem(){
 const d=await fetch('/system').then(r=>r.json());
 document.getElementById('sysinfo').innerHTML=`CPU: ${d.cpu}%<br>RAM: ${d.ram}%<br>IP: ${d.ip}`;
}
setInterval(updateSystem,3000);
async function updateWeather(){
 const r=await fetch("https://api.open-meteo.com/v1/forecast?latitude=43.3&longitude=5.37&current=temperature_2m&timezone=auto");
 const j=await r.json();document.getElementById('meteo').textContent=`${j.current.temperature_2m}°C - Marseille`;
}
updateWeather();

function detectHit(px,py,el){const r=el.getBoundingClientRect();return px>r.left&&px<r.right&&py>r.top&&py<r.bottom;}
function toggleWindow(id){
 const w=document.getElementById(id);
 if(w.style.display==="block"){w.style.display="none";}
 else{w.style.display="block";w.style.left=(window.innerWidth/2-w.offsetWidth/2)+"px";w.style.top=(window.innerHeight/2-w.offsetHeight/2)+"px";}
}

// --- Dessin ---
const canvas=document.getElementById('drawCanvas'),ctx=canvas.getContext('2d');
ctx.lineWidth=3;ctx.lineCap='round';ctx.strokeStyle='#0ff';let drawing=false;
function drawAt(x,y){ctx.lineTo(x,y);ctx.stroke();}

// --- Gestuelle ---
socket.on("hand_state",({state,x,y})=>{
 const px=(x/vw)*window.innerWidth,py=(y/vh)*window.innerHeight;
 cursor.style.left=px+"px";cursor.style.top=py+"px";
 cursor.style.borderColor=(state==="open")?"#0ff":"#f03";

 if(saverActive){
   if(state==="closed"){
     if(!saverStart)saverStart=performance.now();
     const elapsed=performance.now()-saverStart;
     if(elapsed>5000){
       document.getElementById('screensaver').style.display='none';
       saverActive=false;saverStart=null;
     }
   } else saverStart=null;
   return;
 }

 if(state==="closed"){
   holdStart=null;fill.style.clipPath='circle(0%)';
   if(!grabbed){
     windows.forEach(w=>{if(w.style.display==="block"&&detectHit(px,py,w)){grabbed=w;const r=w.getBoundingClientRect();offsetX=px-r.left;offsetY=py-r.top;}});
   }
   if(grabbed){grabbed.style.left=(px-offsetX)+"px";grabbed.style.top=(py-offsetY)+"px";}
 } else {
   grabbed=null;
   if(!holding){
     let t=null;dockIcons.forEach(ic=>{if(detectHit(px,py,ic))t=ic;});
     if(t!==target){target=t;holdStart=null;fill.style.clipPath='circle(0%)';}
     if(target){
       if(!holdStart)holdStart=performance.now();
       const elapsed=performance.now()-holdStart;
       const prog=Math.min(elapsed/HOLD_TIME,1);
       fill.style.clipPath=`circle(${prog*50}% at center)`;
       if(prog>=1){
         holding=true;
         const id="win-"+target.id.split('-')[1];
         if(id==="win-saver"){document.getElementById('screensaver').style.display='block';saverActive=true;}
         else if(id==="win-draw"){ctx.clearRect(0,0,canvas.width,canvas.height);}
         if(document.getElementById(id))toggleWindow(id);
         setTimeout(()=>{holding=false;holdStart=null;fill.style.clipPath='circle(0%)';},400);
       }
     } else fill.style.clipPath='circle(0%)';
   }
 }

 if(document.getElementById('win-draw').style.display==="block"){
   const rect=canvas.getBoundingClientRect();
   const cx=px-rect.left,cy=py-rect.top;
   if(detectHit(px,py,canvas)&&state==="open"){
     if(!drawing){ctx.beginPath();ctx.moveTo(cx,cy);drawing=true;}
     drawAt(cx,cy);
   } else drawing=false;
 }
});
</script>
</body>
</html>